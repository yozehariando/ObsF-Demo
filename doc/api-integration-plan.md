# Development Plan for Enhanced API Integration in dashboard.md

This document outlines the development plan for enhancing the API integration in the DNA Mutation Dashboard without modifying existing component files.

## 1. New Component Files

We'll create these new files to extend functionality without modifying existing components:

1. **`api-service.js`** - A new service for enhanced API integration âœ…
   - Location: `src/components/api/api-service.js`
   - Purpose: Handle API requests, configuration, and data transformation

2. **`api-visualizations.js`** - Custom visualizations for API data âœ…
   - Location: `src/components/api/api-visualizations.js`
   - Purpose: Provide specialized visualization components for API data

3. **`api-utils.js`** - Utility functions specific to API data processing âœ…
   - Location: `src/components/api/api-utils.js`
   - Purpose: Provide helper functions for data processing and validation

4. **`api-upload-component.js`** - File upload component for sequence analysis âœ…
   - Location: `src/components/api/api-upload-component.js`
   - Purpose: Handle FASTA file uploads and model selection

5. **`api-job-tracker.js`** - Job tracking system for sequence analysis âœ…
   - Location: `src/components/api/api-job-tracker.js`
   - Purpose: Track status of analysis jobs and provide user feedback

6. **`api-similarity-service.js`** - Service for finding sequence similarities âœ…
   - Location: `src/components/api/api-similarity-service.js`
   - Purpose: Handle similarity calculations and data processing

## 2. Phased Development Approach

We'll implement the enhanced API integration in three distinct phases:

### Phase 1: Load and Visualize All UMAP Data

This phase focuses on fetching and displaying the database of DNA sequences:

1. **Create Basic Component Structure** âœ…
   - Set up `api-service.js` with core functionality âœ…
   - Set up `api-utils.js` with helper functions âœ…
   - Set up `api-visualizations.js` with basic visualization support âœ…

2. **Implement UMAP Data Loading** âœ…
   - Add function to fetch data from `/pathtrack/umap/all` âœ…
   - Implement JSONL parsing for streaming response âœ…
   - Add data transformation for visualization format âœ…

3. **Enhance Existing Visualizations** âœ…
   - Modify map component to support UMAP coordinate space âœ…
   - Update scatter plot to display UMAP data âœ…
   - Add toggle between geographic and UMAP views â³

4. **Add UI Controls** â³
   - Add API configuration panel â³
   - Implement visualization controls (zoom, filter, etc.) â³
   - Add explanatory text about UMAP visualization âœ…

### Phase 2: User Sequence Upload and Analysis

This phase adds the ability for users to upload and analyze their own sequences:

1. **Create File Upload Component** âœ…
   - Implement drag-and-drop interface for FASTA files âœ…
   - Add file validation (format, size limits) âœ…
   - Include model selection dropdown âœ…
   - Add upload progress indicator âœ…

2. **Implement API Service Enhancements** âœ…
   - Add functions for sequence embedding âœ…
   - Implement job status checking âœ…
   - Add UMAP projection request handling âœ…
   - Create similar sequence retrieval âœ…

3. **Develop Job Tracking System** âœ…
   - Implement job status management âœ…
   - Create polling mechanism âœ…
   - Add progress indicators âœ…
   - Implement event system for status updates âœ…

4. **Implement Similarity Search Service** âœ…
   - Store 'all' endpoint data in JSON format âœ…
   - Implement similarity search against stored data âœ…
   - Add visualization of similar sequences âœ…
   - Create similarity metrics calculation âœ…

5. **Implement UMAP Projection** âœ…
   - Update visualizations to highlight user sequences âœ…
   - Add special styling for user-uploaded sequences âœ…
   - Implement functions to update visualizations with new data âœ…

6. **Enhance User Interface** â³
   - Add notifications for job completion âœ…
   - Implement error recovery options âœ…
   - Create help tooltips for complex features â³

### Phase 3: Refinement and Advanced Features

This phase polishes the implementation and adds advanced features:

1. **Optimize Performance** ğŸ”œ
   - **Data Loading Optimization**:
     - Implement progressive loading for large datasets
     - Add pagination support for the 'all' endpoint
     - Implement data streaming for continuous loading
     - Use web workers for processing large datasets without blocking UI
   
   - **Caching Strategy**:
     - Implement tiered caching (memory â†’ IndexedDB â†’ API)
     - Add cache expiration and refresh policies
     - Use service workers for offline capability
     - Implement background refresh of cached data
   
   - **Rendering Optimization**:
     - Use canvas instead of SVG for very large datasets (>10,000 points)
     - Implement data downsampling for overview visualizations
     - Add level-of-detail rendering based on zoom level
     - Use WebGL for hardware-accelerated rendering of large datasets
   
   - **Network Optimization**:
     - Implement request batching for multiple API calls
     - Add compression for API responses
     - Use HTTP/2 for parallel requests
     - Implement retry with exponential backoff for failed requests

2. **Enhance User Experience** ğŸ”œ
   - Add animations and transitions
   - Improve tooltips and information display
   - Add keyboard shortcuts and accessibility features

3. **Add Advanced Analysis Tools** ğŸ”œ
   - Implement filtering and sorting options
   - Add statistical analysis features
   - Create export and sharing functionality

## 3. Implementation Details

### Phase 1: Load and Visualize All UMAP Data

#### Step 1: Create api-service.js âœ…
This file will handle:
- Advanced API request configuration âœ…
- Multiple endpoint support (focusing on `/pathtrack/umap/all` initially) âœ…
- Error handling and retry logic âœ…
- Data transformation for visualization âœ…

#### Step 2: Create api-visualizations.js âœ…
This file will contain:
- Specialized visualization components for API data âœ…
- Custom D3.js visualizations for UMAP data âœ…
- Coordinate space mapping for the map component âœ…

#### Step 3: Create api-utils.js âœ…
This file will provide:
- Helper functions for data processing âœ…
- Validation utilities âœ…
- Format conversion tools âœ…

#### Step 4: Update dashboard.md âœ…
We've enhanced the dashboard with:
- Integration with API service for data fetching âœ…
- Loading indicators for API requests âœ…
- Error handling for API failures âœ…
- Explanatory text about UMAP visualization âœ…
- Controls for refreshing API data âœ…

### Phase 2: User Sequence Upload and Analysis

#### Step 1: Create api-upload-component.js âœ…
This file will provide:
- File upload UI with drag-and-drop support âœ…
- FASTA file validation âœ…
- Model selection options âœ…
- Upload progress tracking âœ…

#### Step 2: Enhance api-service.js for sequence analysis âœ…
We'll add these functions:
- `uploadSequence(file, model)` - Submit sequence to `/pathtrack/sequence/embed` âœ…
- `checkJobStatus(jobId)` - Poll `/pathtrack/jobs/{job_id}` âœ…
- `getUmapProjection(embeddingId)` - Request projection via `/pathtrack/sequence/umap` âœ…
- `getSimilarSequences(embeddingId)` - Get similar sequences via `/pathtrack/sequence/similar` âœ…

#### Step 3: Create api-job-tracker.js âœ…
This file will handle:
- Job status tracking âœ…
- Polling mechanism âœ…
- Progress indicators âœ…
- Event-based status updates âœ…

#### Step 4: Create api-similarity-service.js âœ…
This file will handle:
- Storing 'all' endpoint data in JSON format âœ…
- Implementing similarity search against stored data âœ…
- Processing similarity results for visualization âœ…
- Calculating similarity metrics âœ…

#### Step 5: Update api-visualizations.js for user sequences âœ…
We'll add these functions:
- `highlightUserSequence(component, sequence)` - Highlight user sequence âœ…
- `showSimilarityConnections(component, userSeq, similarSeqs)` - Show connections âœ…
- `createSimilarityTooltip(sequence, similarity)` - Create tooltip for similar sequences âœ…

## 4. UMAP Visualization Strategy

For the UMAP data from `/pathtrack/umap/all`:

1. **Scatter Plot Visualization**: âœ…
   - Use UMAP coordinates directly for X and Y positions âœ…
   - Color points based on available metadata (e.g., country if available) âœ…
   - Enable clustering visualization of similar DNA sequences âœ…

2. **Map Visualization**: âœ…
   - Repurpose the map component to show UMAP coordinate space instead of geographic space âœ…
   - Use UMAP coordinates directly instead of latitude/longitude âœ…
   - Add grid lines and labels to indicate UMAP space âœ…
   - Provide toggle between geographic view and UMAP view â³

3. **Details Panel**: âœ…
   - Show sequence hash, accession, first date, and first country âœ…
   - Potentially fetch additional sequence details on demand â³

## 5. Similarity Search Strategy

We'll implement a new approach for finding similar sequences:

1. **Data Storage**: âœ…
   - Fetch data from 'all' endpoint âœ…
   - Store in JSON format for efficient access âœ…
   - Use this data for both visualization and similarity search âœ…

2. **Similarity Calculation**: âœ…
   - When user uploads a sequence, search in stored JSON data âœ…
   - Calculate similarity based on sequence features âœ…
   - Return top matches with similarity scores âœ…

3. **Visualization Integration**: âœ…
   - Display user sequence alongside reference data âœ…
   - Highlight similar sequences with visual indicators âœ…
   - Show similarity scores and metadata âœ…

## 6. Comprehensive Workflow

The complete user experience will follow this flow:

1. **Initial Load**: âœ…
   - Load all UMAP data from `/pathtrack/umap/all` âœ…
   - Display in map and scatter plot visualizations âœ…
   - Allow exploration of existing sequences âœ…
   - Store data in JSON format for similarity search âœ…

2. **User Sequence Analysis**: âœ…
   - User uploads a FASTA file âœ…
   - System processes through embedding â†’ UMAP â†’ similarity analysis âœ…
   - User's sequence is added to visualizations âœ…
   - Similar sequences are highlighted âœ…

3. **Interactive Exploration**: â³
   - Toggle between geographic and UMAP views â³
   - Select sequences to view details âœ…
   - Filter and sort similar sequences ğŸ”œ
   - Compare user's sequence with database sequences âœ…

4. **Results and Export**: ğŸ”œ
   - View detailed analysis results
   - Export findings or visualizations
   - Save user's sequence for future reference

## 7. Testing Strategy

- Test each new component in isolation âœ…
- Verify integration with existing components âœ…
- Test with various API response scenarios âœ…
- Ensure error handling works properly âœ…

Test cases:
- Successful API requests with UMAP data âœ…
- Failed API requests with appropriate error handling âœ…
- Integration with existing map and scatter plot components âœ…
- Performance with large UMAP datasets âœ…
- Correct visualization of UMAP coordinate space âœ…
- Complete sequence upload and analysis workflow âœ…
- Similarity search functionality and accuracy âœ…

## 8. Implementation Timeline

### Phase 1: Load and Visualize All UMAP Data âœ…
- **Step 1**: Set up project structure and create basic component files âœ…
- **Step 2**: Implement UMAP data fetching and JSONL parsing âœ…
- **Step 3**: Develop data transformation and integration with map component âœ…
- **Step 4**: Implement scatter plot integration and toggle functionality âœ…
- **Step 5**: Add UI controls and test Phase 1 functionality â³

### Phase 2: User Sequence Upload and Analysis âœ…
- **Step 1**: Create file upload component and implement submission to API âœ…
- **Step 2**: Develop job tracking system and status indicators âœ…
- **Step 3**: Implement similarity search service âœ…
- **Step 4**: Add UMAP projection and visualization integration âœ…
- **Step 5**: Implement similarity analysis and highlighting features âœ…
- **Step 6**: Test and refine Phase 2 functionality âœ…

### Phase 3: Refinement and Advanced Features ğŸ”œ
- **Step 1**: Optimize performance for large datasets ğŸ”œ
- **Step 2**: Enhance user experience with animations and improved tooltips ğŸ”œ
- **Step 3**: Implement advanced analysis tools and filtering options ğŸ”œ
- **Step 4**: Add export and sharing functionality ğŸ”œ
- **Step 5**: Final testing, bug fixes, and documentation ğŸ”œ

## 9. Success Criteria

The implementation will be considered successful when:
- Users can fetch UMAP data from the API âœ…
- UMAP data is properly visualized in both the scatter plot and map components âœ…
- Users can toggle between geographic and UMAP views in the map component â³
- Users can upload their own sequences for analysis âœ…
- The system properly processes and visualizes user sequences âœ…
- Similar sequences are identified and displayed âœ…
- Error handling provides clear feedback to users âœ…
- The solution works without modifying existing component files âœ…

## 10. Known Issues and Improvements

1. âœ… **Progress Bar Animation**: Fixed the progress bar animation and status text updates during job processing.
2. â³ **Toggle Between Geographic and UMAP Views**: Still need to implement this feature.
3. â³ **Help Tooltips for Complex Features**: Still need to add these for better user guidance.
4. ğŸ”œ **Filtering and Sorting Options for Similar Sequences**: Planned for Phase 3.
5. ğŸ”œ **Performance Optimization for Large Datasets**: Planned for Phase 3.

Legend:
- âœ… Completed
- â³ In progress
- ğŸ”œ Next up 